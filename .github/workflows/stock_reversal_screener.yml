name: Stock Reversal Screener Analysis

# å®šä¹‰è§¦å‘æœºåˆ¶
on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (e.g., Testing, Urgent Update)'
        required: false
        default: 'Manual Trigger'

  # 2. å®šæ—¶è§¦å‘ (æ¯å¤© 18:00 åŒ—äº¬æ—¶é—´ / UTC+8)
  schedule:
    # æ¯å¤© 10:00 UTC (å³ 18:00 åŒ—äº¬æ—¶é—´/ä¸Šæµ·æ—¶é—´) è¿è¡Œ
    - cron: '33 13 * * *'

  # 3. è„šæœ¬å’Œå·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main
    paths:
      # å…³æ³¨æ–°çš„è„šæœ¬åç§°
      - 'stock_reversal_screener.py' 
      # å…³æ³¨æ–°çš„å·¥ä½œæµåç§°
      - '.github/workflows/stock_reversal_screener.yml'

jobs:
  run_screener:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: Install Dependencies
        run: pip install pandas joblib

      # è®¾ç½®ä¸Šæµ·æ—¶åŒº
      - name: Set Timezone to Asia/Shanghai
        run: echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
        
      - name: Execute Stock Screener Script
        # è°ƒç”¨æ–°çš„è„šæœ¬åç§°
        run: python stock_reversal_screener.py

      # --- æ¨é€ç»“æœåˆ°ä»“åº“ ---
      - name: Configure Git for Push
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          
      - name: Add and Commit Results
        # å°†æ–°ç”Ÿæˆçš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
        run: |
          if [ -d "screener_results" ]; then
            git add screener_results/*.csv screener_results/*/*.csv
            if git diff --cached --exit-code; then
              echo "No new results to commit."
            else
              git commit -m "ğŸ“ˆ Auto: Update stock screening results [${{ github.event_name }}]"
              echo "New results committed."
            fi
          else
            echo "Output directory 'screener_results' not found. Script might have failed or found no match."
          fi

      - name: Push Changes to Main Branch
        run: git push
